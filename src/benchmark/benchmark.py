import matplotlib.pyplot as plt
import tensorflow as tf
import json
import glob
import numpy as np
import os

from src.statphy.models.percolation import generate_data

model = tf.keras.models.load_model("saved_models/CNN_L128_N10000/saved-model.h5")

#X, _, _ = generate_data(L=128, 
#                        p_arr=[0.5928],
#                        max_configs_per_p=1000)

def load_synthetic_config(synthetic_data_path='data/generated'):
    """
        Read the .npy files generated by the GAN. Each file corresponds
        to a spin configuration. 
        
        Output: numpy array of shape (n_configs, image_size, image_size)
                ready to by an input of the CNN.
    """
    
    list_generated_configs = glob.glob(os.path.join(synthetic_data_path, '*.npy'))
    synthetic_configs = []

    for file in list_generated_configs:
        synthetic_configs.append(np.load(file).reshape(128, 128))
    synthetic_configs = np.array(synthetic_configs)
    
    return synthetic_configs

with open("saved_models/CNN_L128_N10000/labels.json", 'r') as f:
    labels = json.load(f)

reversed_labels = {value : float(key) for (key, value) in labels.items()}

X = load_synthetic_config()
y_pred = model.predict(X).argmax(axis=1)
y_pred = [reversed_labels[i] for i in y_pred]

plt.hist(y_pred)
plt.title("Distribution of the value of p for GAN generated critical configurations")
if not os.path.exists('saved_files'):
    os.makedirs('saved_files')
plt.savefig('saved_files/hist_GANgenerated_configs.png')